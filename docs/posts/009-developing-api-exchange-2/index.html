<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Deskriders.dev">
    <meta name="description" content="Improving developer productivity">
    <meta name="keywords" content="blog,developer">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Developing API exchange sharing service - Part II"/>
<meta name="twitter:description" content="Please check the previous part to know the background of this project.
In this part, we&#39;ll dive into code and deploy a simple API to AWS Lambda and Api Gateway.
I&#39;ll be using Python Flask framework for defining the APIs and Serverless framework to manage the infrastructure and deployment.
Please make sure you have Python3 and relatively newer version of nodejs installed and working to follow along.
The first step is to create a new project folder and initialise package."/>

    <meta property="og:title" content="Developing API exchange sharing service - Part II" />
<meta property="og:description" content="Please check the previous part to know the background of this project.
In this part, we&#39;ll dive into code and deploy a simple API to AWS Lambda and Api Gateway.
I&#39;ll be using Python Flask framework for defining the APIs and Serverless framework to manage the infrastructure and deployment.
Please make sure you have Python3 and relatively newer version of nodejs installed and working to follow along.
The first step is to create a new project folder and initialise package." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/009-developing-api-exchange-2/" />
<meta property="article:published_time" content="2020-01-03T18:51:44+00:00" />
<meta property="article:modified_time" content="2020-01-03T18:51:44+00:00" />


    
      <base href="/posts/009-developing-api-exchange-2/">
    
    <title>
  Developing API exchange sharing service - Part II · deskriders
</title>

    
      <link rel="canonical" href="/posts/009-developing-api-exchange-2/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="/css/coder.min.28d751104f30c16da1aa1bb04015cbe662cacfe0d1b01af4f2240ad58580069c.css" integrity="sha256-KNdREE8wwW2hqhuwQBXL5mLKz&#43;DRsBr08iQK1YWABpw=" crossorigin="anonymous" media="screen" />
    

    

    

    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.62.0" />
  </head>

  
  
  <body class="colorscheme-light">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      deskriders
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="/posts/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/projects/">Projects</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="/notes/">Notes</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Developing API exchange sharing service - Part II</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-01-03T18:51:44Z'>
                January 3, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              4 minutes read
            </span>
          </div>
          <div class="categories">
  <i class="fas fa-folder"></i>
    <a href="/categories/tutorial/">tutorial</a></div>

          <div class="tags">
  <i class="fas fa-tag"></i>
    <a href="/tags/python/">python</a>
      <span class="separator">•</span>
    <a href="/tags/serverless/">serverless</a>
      <span class="separator">•</span>
    <a href="/tags/aws/">aws</a></div>

        </div>
      </header>

      <div>
        <p>Please check the <a href="https://dev.to/namuan/developing-api-exchange-sharing-service-part-i-nhp">previous part</a> to know the background of this project.</p>
<p>In this part, we'll dive into code and deploy a simple API to AWS Lambda and Api Gateway.</p>
<p>I'll be using Python <a href="https://palletsprojects.com/p/flask/">Flask</a> framework for defining the APIs and <a href="https://serverless.com">Serverless framework</a> to manage the infrastructure and deployment.</p>
<p>Please make sure you have Python3 and relatively newer version of nodejs installed and working to follow along.</p>
<p>The first step is to create a new project folder and initialise package.json file which will be used to define and install Serverless plugins.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mkdir api-exchange-server
$ <span style="color:#fff;font-weight:bold">cd</span> api-exchange-server

$ npm init
$ <span style="color:#007f7f"># Enter all the way to generate package.json file</span>
</code></pre></div><p>Installing Serverless CLI.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ npm install -D serverless <span style="color:#007f7f"># Although better to install this globally</span>
</code></pre></div><p>If Serverless CLI is installed globally then you don't need to prefix the <code>serverless</code> commands with <code>./nodes_modules/.bin/</code>.</p>
<p>Let's create a new project</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./node_modules/.bin/serverless
Name the project serverless-project. Ignore the project name as we<span style="color:#f00">&#39;</span>ll move the files to the current folder.
</code></pre></div><p>We'll just copy the files that we need from the generated project.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ mv serverless-project/serverless.yml .
$ mv serverless-project/.gitignore .
$ rm -rf serverless-project
</code></pre></div><p>After removing the folder generated by the Serverless CLI, this is how the structure looks like</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ls -la
total <span style="color:#ff0;font-weight:bold">336</span>
drwxr-xr-x    <span style="color:#ff0;font-weight:bold">7</span> nmn  staff     <span style="color:#ff0;font-weight:bold">224</span>  <span style="color:#ff0;font-weight:bold">1</span> Jan 09:00 .
drwxr-xr-x   <span style="color:#ff0;font-weight:bold">15</span> nmn  staff     <span style="color:#ff0;font-weight:bold">480</span>  <span style="color:#ff0;font-weight:bold">1</span> Jan 08:53 ..
-rw-r--r--    <span style="color:#ff0;font-weight:bold">1</span> nmn  staff     <span style="color:#ff0;font-weight:bold">192</span>  <span style="color:#ff0;font-weight:bold">1</span> Jan 08:58 .gitignore
drwxr-xr-x  <span style="color:#ff0;font-weight:bold">386</span> nmn  staff   <span style="color:#ff0;font-weight:bold">12352</span>  <span style="color:#ff0;font-weight:bold">1</span> Jan 08:54 node_modules
-rw-r--r--    <span style="color:#ff0;font-weight:bold">1</span> nmn  staff  <span style="color:#ff0;font-weight:bold">156725</span>  <span style="color:#ff0;font-weight:bold">1</span> Jan 08:54 package-lock.json
-rw-r--r--    <span style="color:#ff0;font-weight:bold">1</span> nmn  staff     <span style="color:#ff0;font-weight:bold">271</span>  <span style="color:#ff0;font-weight:bold">1</span> Jan 08:54 package.json
-rw-r--r--    <span style="color:#ff0;font-weight:bold">1</span> nmn  staff    <span style="color:#ff0;font-weight:bold">3206</span>  <span style="color:#ff0;font-weight:bold">1</span> Jan 08:58 serverless.yml
</code></pre></div><p>Let's open the folder in your <a href="https://code.visualstudio.com">favourite</a> text editor.</p>
<p>To connect AWS Lambda to Flask handlers, we'll need to install <a href="https://github.com/logandk/serverless-wsgi">serverless-wsgi</a> plugin to do the necessary transformation.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./node_modules/.bin/serverless plugin search -q wsgi
<span style="color:#ff0;font-weight:bold">1</span> plugin(s) found <span style="color:#fff;font-weight:bold">for</span> your search query <span style="color:#0ff;font-weight:bold">&#34;wsgi&#34;</span>

serverless-wsgi - Serverless plugin to deploy WSGI applications (Flask/Django/Pyramid etc.) and bundle Python package

To install a plugin run <span style="color:#0ff;font-weight:bold">&#39;serverless plugin install --name plugin-name-here&#39;</span>

It will be automatically downloaded and added to your package.json and serverless.yml file
</code></pre></div><p>As stated by the really useful help message, we'll install this plugin.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./node_modules/.bin/serverless plugin install --name serverless-wsgi
</code></pre></div><p>Next, we'll create a simple flask Api which will return the environment variables in json. As this code will run on Lambda, you'll be able to see all the environment variables available for the function.</p>
<p>File -&gt; New -&gt; &ldquo;api.py&rdquo;</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">import</span> os
<span style="color:#fff;font-weight:bold">from</span> flask <span style="color:#fff;font-weight:bold">import</span> Flask, jsonify

app = Flask(__name__)


@app.route(<span style="color:#0ff;font-weight:bold"></span><span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">/</span><span style="color:#0ff;font-weight:bold">&#34;</span>, methods=[<span style="color:#0ff;font-weight:bold"></span><span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">GET</span><span style="color:#0ff;font-weight:bold">&#34;</span>])
<span style="color:#fff;font-weight:bold">def</span> environ():
    <span style="color:#fff;font-weight:bold">return</span> jsonify({k:v <span style="color:#fff;font-weight:bold">for</span> k, v in os.environ.items()})
</code></pre></div><p>Just noticed that we haven't installed Flask yet so let's create a requirements file and install it in a new virtualenv.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python3 -m venv venv
$ <span style="color:#fff;font-weight:bold">source</span> venv/bin/activate
$ pip install flask
$ pip freeze &gt; requirements.txt
</code></pre></div><p>With the project completed, we can test the Api by running it locally.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ FLASK_APP=api.py flask run
</code></pre></div><p>Next we need to tell/configure Serverless framework to connect Lambda to Flask App. There are few ways to setup the integration.
Here we'll be using <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html">AWS Lambda Proxy</a> integration for the API handler.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">functions:
  api:
    handler: wsgi_handler.handler
    events:
      - http: ANY /
      - http: ANY {proxy+}
</code></pre></div><p>We also need to tell wsgi plugin where to find the Flask API, so let define a custom section for this.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">custom:
  wsgi:
    app: api.app
</code></pre></div><p>Although the wsgi plugin can manage python dependencies, I had better luck with using a different plugin <a href="https://github.com/UnitedIncome/serverless-python-requirements">serverless-python-requirements</a> so we'll install it as well</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./node_modules/.bin/serverless plugin install --name serverless-python-requirements
</code></pre></div><p>Now let's try packaging up the app.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./node_modules/.bin/serverless package
</code></pre></div><p>If successful, the generated zip file will be placed in <code>.serverless</code> folder. If we examine that file, we'll find that it contains all the files in the current folder including the giant <code>venv</code> and <code>node_modules</code> folder 😱.</p>
<p><img src="/images/009/k1bftpwralpe20xx6p20.jpg" alt="serverless package"></p>
<p>I'm sure python requirements folder is right up there as well.</p>
<p>Luckily, we can configure what to include in the zip file so we'll exclude everything and just add the file that we need to run the application. Note that the plugin will still take care of all the python dependencies defined in requirements.txt file.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">package:
  exclude:
    - <span style="color:#0ff;font-weight:bold">&#34;**&#34;</span>
  include:
    - <span style="color:#0ff;font-weight:bold">&#34;api.py&#34;</span>
</code></pre></div><p>This is what it looks like with the changes that we made in the serverless.yml file.</p>
<p><img src="/images/009/8kgmqgsu6khi6692eatb.png" alt="Serverless wsgi setup"></p>
<p>You can also check the complete <a href="https://github.com/namuan/api-exchange-server-guide/blob/master/serverless.yml">file</a>.</p>
<p>That should be everything to deploy on AWS Lambda. The next step requires an AWS profile with appropriate permissions to deploy and create Lambda resources.</p>
<blockquote>
<p>Note that this is where you may be charged.</p>
</blockquote>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ AWS_PROFILE=myprofile ./node_modules/.bin/serverless deploy -v
</code></pre></div><p>It will take some time to create all the resources before printing out the endpoints that it generated for the Api Gateway.</p>
<p><img src="/images/009/bs3nb0oxq24qlnix7bvh.png" alt="Serverless output"></p>
<p>You should be able to hit the above endpoint via curl or open it up directly in the browser. There you can see all the environment variables available to your lambda function.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -v https://mcb1lbc2ti.execute-api.us-east-1.amazonaws.com/dev
<span style="color:#007f7f"># or</span> 
open https://mcb1lbc2ti.execute-api.us-east-1.amazonaws.com/dev
</code></pre></div><p>Once you are done with it, don't forget to remove the setup.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ AWS_PROFILE=myprofile ./node_modules/.bin/serverless remove -v
</code></pre></div>
      </div>

      <footer>
        


        
        
        
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
    
      
        © 2019 - 2020
      
       Deskriders.dev 
    
    
       · 
      Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    
    
  </section>
</footer>

    </main>

    

  </body>

</html>
